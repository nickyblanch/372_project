#include <Arduino.h>
#include "timer.h"  
#include "screamingRoboBat.h"
#include "switch.h"

bool inSonarRange = false;


// ---------------------------------------------------------------------- //
// State Machines
typedef enum stateEnum {wait_high, wait_low} stateEnum;
volatile stateEnum echoSignal = wait_high; 


// ---------------------------------------------------------------------- //
// Main Function
int main() {
  sei(); 
  initSwitchPB3();
  initTimer4();
  initTimer1();
  
  // Hardware initializations
  Serial.begin(9600); // For debugging purposes
  initSonar();
  Serial.println("Initialize Sonar Success");

  while(true){
    //Serial.println(".");
    if(inSonarRange){
      Serial.println("<<<<<<OPENING DOOR>>>>>>");
    }
    delayUs(60000);
    sendPulse();
    switch(echoSignal){
      case wait_high:
        TCNT4 = 0;
      break;
      case wait_low:
        TCNT4 = 0;
      break;
    }
  }
  return 0;
}

// ---------------------------------------------------------------------- //
// Interrupt Service Routines
ISR(PCINT0_vect){//Main code is interrupted if the switch connected to pin50 changes
  if(echoSignal == wait_high){
    echoSignal = wait_low;
  }
  else { 
    if(TCNT4 < inches(5)){//Within (roughly) 12 inches away from the device the condition is true
      inSonarRange = true;
    }
    else{
      inSonarRange = false;
      echoSignal = wait_high;
    }
  }
}
